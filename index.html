<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cippo Chilometrico</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <style>body{margin:0;font-family:sans-serif;text-align:center;background:#0f172a;color:white}</style>
</head>
<body>
  <h1>ðŸš‚ Cippo Chilometrico</h1>
  <p id="km">Premi Avvia</p>
  <button onclick="start()">Avvia</button>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(()=>console.log("Service Worker registrato"));
    }

    const cippi = [
      { km:0, lat:45.4642, lon:9.1900 },
      { km:10, lat:45.5142, lon:9.2900 },
      { km:20, lat:45.5642, lon:9.3900 }
    ];

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function computeKm(lat, lon) {
      for (let i=0; i<cippi.length-1; i++) {
        let a = cippi[i], b = cippi[i+1];
        let distAB = haversine(a.lat,a.lon,b.lat,b.lon);
        let distAP = haversine(a.lat,a.lon,lat,lon);
        if (distAP <= distAB) {
          let kmVal = a.km + distAP/1000;
          let kmInt = Math.floor(kmVal);
          let metri = Math.round((kmVal-kmInt)*1000);
          return `KM ${kmInt}+${metri}`;
        }
      }
      return "Fuori linea";
    }

    function start(){
      if (!navigator.geolocation) {
        document.getElementById("km").textContent = "GPS non supportato";
        return;
      }
      navigator.geolocation.watchPosition(pos => {
        const {latitude,longitude} = pos.coords;
        document.getElementById("km").textContent = computeKm(latitude,longitude);
      }, err => {
        document.getElementById("km").textContent = "Errore GPS: " + err.message;
      }, {enableHighAccuracy:true});
    }
  </script>
</body>
</html>